{% extends "layout.html" %}
{% block title %}Home{% endblock %}

{% block css_content %}
    <style>
        #drop-area {
          border: 2px dashed #ccc;
          border-radius: 20px;
          width: 480px;
          font-family: sans-serif;
          margin: 100px auto;
          padding: 20px;
        }
        #drop-area.highlight {
          border-color: purple;
        }
        p {
          margin-top: 0;
        }
        .my-form {
          margin-bottom: 10px;
        }
        #gallery {
          margin-top: 10px;
        }
        #gallery img {
          width: 150px;
          margin-bottom: 10px;
          margin-right: 10px;
          vertical-align: middle;
        }
        .button {
          display: inline-block;
          padding: 10px;
          background: #ccc;
          cursor: pointer;
          border-radius: 5px;
          border: 1px solid #ccc;
        }
        .button:hover {
          background: #ddd;
        }
        #fileElem {
          display: none;
        }
    </style>
{% endblock %}


{% block content %}
<!--    <input type="file" name="file" id="file">-->
<!--    <input type="button" id="upload" value="Upload">-->

<div class="container">
    <div id="drop-area">
        <form class="my-form">
            <p>Upload file to S3</p>
            <input type="file" id="fileElem" accept="*/*" onchange="handleFiles(this.files)">
            <progress id="progress-bar" max=100 value=0></progress>
            <label class="btn btn-primary" for="fileElem">Select some files</label>
        </form>
        <div id="gallery"></div>
    </div>
<!--    <label class="btn btn-primary" for="fileElem">Resume Uploading</label>-->
</div>

{% endblock %}

{% block js_content %}
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.617.0.min.js"></script>
    <script>

        // ************************ Drag and drop ***************** //
        let dropArea = document.getElementById("drop-area")

        // Prevent default drag behaviors
        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropArea.addEventListener(eventName, preventDefaults, false)
          document.body.addEventListener(eventName, preventDefaults, false)
        })

        // Highlight drop area when item is dragged over it
        ;['dragenter', 'dragover'].forEach(eventName => {
          dropArea.addEventListener(eventName, highlight, false)
        })

        ;['dragleave', 'drop'].forEach(eventName => {
          dropArea.addEventListener(eventName, unhighlight, false)
        })

        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false)

        function preventDefaults (e) {
          e.preventDefault()
          e.stopPropagation()
        }

        function highlight(e) {
          dropArea.classList.add('highlight')
        }

        function unhighlight(e) {
          dropArea.classList.remove('active')
        }

        function handleDrop(e) {
          var dt = e.dataTransfer
          var files = dt.files

          handleFiles(files)
        }

        let uploadProgress = []
        let progressBar = document.getElementById('progress-bar')

        function initializeProgress(numFiles) {
          progressBar.value = 0
          uploadProgress = []

          for(let i = numFiles; i > 0; i--) {
            uploadProgress.push(0)
          }
        }

        function updateProgress(fileNumber, percent) {
          uploadProgress[fileNumber] = percent
          let total = uploadProgress.reduce((tot, curr) => tot + curr, 0) / uploadProgress.length
          console.debug('update', fileNumber, percent, total)
          progressBar.value = total
        }

        function handleFiles(files) {
          files = [...files]
          initializeProgress(files.length)
          files.forEach(uploadFile)
          files.forEach(previewFile)
        }

        function previewFile(file) {
          let reader = new FileReader()
          reader.readAsDataURL(file)
          reader.onloadend = function() {
            let img = document.createElement('img')
            img.src = reader.result
            document.getElementById('gallery').appendChild(img)
          }
        }

        function uploadFile(file, i) {
          var url = 'https://api.cloudinary.com/v1_1/joezimim007/image/upload'
          var xhr = new XMLHttpRequest()
          var formData = new FormData()
          xhr.open('POST', url, true)
          xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')

          // Update progress (can be used to show progress indicator)
          xhr.upload.addEventListener("progress", function(e) {
            updateProgress(i, (e.loaded * 100.0 / e.total) || 100)
          })

          xhr.addEventListener('readystatechange', function(e) {
            if (xhr.readyState == 4 && xhr.status == 200) {
              updateProgress(i, 100) // <- Add this
            }
            else if (xhr.readyState == 4 && xhr.status != 200) {
              // Error. Inform the user
            }
          })

          formData.append('upload_preset', 'ujpu6gyk')
          formData.append('file', file)
          xhr.send(formData)
        }

    </script>


    <script>

        var file, fileKey, buffer, bucket;
        var startTime = new Date();
        var partNum = 0;
        var defaultSize = 1024 * 1024 * 5;
        var partSize = defaultSize;
        var numPartsLeft;
        var maxUploadTries = 3;
        var multiPartParams
        var multipartMap = {
            Parts: []
        };


        $(document).ready(function(){
            bucket = "jfourie-test"
            AWS.config.apiVersions = {
                s3: '2006-03-01'
            };

            var s3 = new AWS.S3({
                accessKeyId: 'AKIA2YSWAZCCRK2H3SHJ',
                secretAccessKey: '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'
            });

            function completeMultipartUpload(s3, doneParams) {
                s3.completeMultipartUpload(doneParams, function(err, data) {
                    if (err) {
                      console.log("An error occurred while completing the multipart upload");
                      console.log(err);
                    } else {
                      var delta = (new Date() - startTime) / 1000;
                      alert("finished loading");
                      console.log('Completed upload in', delta, 'seconds');
                      console.log('Final upload data:', data);
                    }
                });
            }


            function uploadPart(s3, multipart, partParams, tryNum) {
                var tryNum = tryNum || 1;
                s3.uploadPart(partParams, function(multiErr, mData) {
                    if (multiErr){
                        console.log('multiErr, upload part error:', multiErr);
                        if (tryNum < maxUploadTries) {
                            console.log('Retrying upload of part: #', partParams.PartNumber)
                            uploadPart(s3, multipart, partParams, tryNum + 1);
                        } else {
                            console.log('Failed uploading part: #', partParams.PartNumber)
                        }
                        return;
                    }
                    multipartMap.Parts[this.request.params.PartNumber - 1] = {
                        ETag: mData.ETag,
                        PartNumber: Number(this.request.params.PartNumber)
                    };
                    console.log("Completed part", this.request.params.PartNumber);
                    console.log('mData', mData);

                    if (--numPartsLeft > 0) return; // complete only when all parts uploaded

                    var doneParams = {
                        Bucket: bucket,
                        Key: fileKey,
                        MultipartUpload: multipartMap,
                        UploadId: multipart.UploadId
                    };

                    console.log("Completing upload...");
                    completeMultipartUpload(s3, doneParams);
                });
            }


            $('#upload').click(function(e){
                file = $('#file').prop('files')[0];

                const reader = new FileReader();
                reader.readAsArrayBuffer(file)

                reader.onloadend = function onloadend(){
                    console.log('on_loaded');
                    buffer = reader.result;
                    startTime = new Date();
                    partNum = 0;
                    fileKey = file.name
                    partSize = file.size / 10 > defaultSize ? file.size / 10 : defaultSize;
                    numPartsLeft = Math.ceil(file.size / partSize);
                    maxUploadTries = 3;
                    multiPartParams = {
                        Bucket: bucket,
                        Key: fileKey,
                        ContentType: file.type
                    };
                    var multipartMap = {
                        Parts: []
                    };

                    console.log("Creating multipart upload for:", fileKey);
                    s3.createMultipartUpload(multiPartParams, function(mpErr, multipart){
                        if (mpErr) { console.log('Error!', mpErr); return; }
                        console.log("Got upload ID", multipart.UploadId);

                        // Grab each partSize chunk and upload it as a part
                        for (var rangeStart = 0; rangeStart < buffer.byteLength; rangeStart += partSize) {
                            partNum++;
                            var end = Math.min(rangeStart + partSize, buffer.byteLength),
                                partParams = {
                                  Body: buffer.slice(rangeStart, end),
                                  Bucket: bucket,
                                  Key: fileKey,
                                  PartNumber: String(partNum),
                                  UploadId: multipart.UploadId
                                };

                            // Send a single part
                            console.log('Uploading part: #', partParams.PartNumber, ', Range start:', rangeStart);
                            uploadPart(s3, multipart, partParams);
                        }
                    });
                }
            })
        });
    </script>
{% endblock %}